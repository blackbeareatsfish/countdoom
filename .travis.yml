#
# Config file for automatic testing at Travis-CI.com
#
# Once tests are performed, a coverage report is sent out to CodeClimate.com
# See https://docs.codeclimate.com/docs/travis-ci-test-coverage
#

# Setup environment for Python builds.
dist: xenial
language: python
python:
  - "3.8"
  - "3.7"
  - "3.6"
  - "3.5"
  # - "pypy3"

# Declare required variables for Code Climate
env:
  global:
    - GIT_COMMITTED_AT=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then git log -1 --pretty=format:%ct; else git log -1 --skip 1 --pretty=format:%ct; fi)
    - CC_TEST_REPORTER_ID=eb5a902253f7a3dfa19e6c4507825f5911142de119b037a27d276510845ed588

before_install:
  # Download Code Climate test reporter.
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter

before_script:
  # Warn Code Climate that a test is about to run.
  - ./cc-test-reporter before-build

# Install dependencies.
install:
  - pip install --upgrade tox-travis
  - pip install .[lint]
  - pip install .[test]

# Run tests.
script:
  - pylint ./countdoom/ ./tests/*.py
  - if [[ $TRAVIS_PYTHON_VERSION != '3.8' ]]; then (flake8 .); fi
  - if [[ $TRAVIS_PYTHON_VERSION == '3.6' ]]; then (black --check --diff .); fi
  - if [[ $TRAVIS_PYTHON_VERSION == '3.6' ]]; then (coverage run --source countdoom --module pytest; coverage xml); fi
  - tox

after_success:
  # Submit test results to Code Climate.
  - if [[ $TRAVIS_PYTHON_VERSION == '3.6' ]]; then ./cc-test-reporter format-coverage --input-type coverage.py; fi
  - if [[ $TRAVIS_PYTHON_VERSION == '3.6' ]]; then ./cc-test-reporter upload-coverage; fi
  # Submit test results to CodeCov.
  - if [[ $TRAVIS_PYTHON_VERSION == '3.6' ]]; then codecov; fi

# Assuming you have installed the travis-ci CLI tool, after you
# create the Github repo and add it to Travis, run the
# following command to finish PyPI deployment setup:
# $ travis encrypt --add deploy.password
#deploy:
#  provider: pypi
#  distributions: sdist bdist_wheel
#  user: renemarc
#  password:
#    secure: PLEASE_REPLACE_ME
#  on:
#    tags: true
#    repo: renemarc/countdoom
#    python: 3.6
